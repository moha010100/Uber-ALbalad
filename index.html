<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Uber Albalad</title>
<style>
  :root{
    --orange:#ff9800;
    --dark:#1a1a1a;
    --card:#ffffff;
    --muted:#666;
    --accent:#e64a19; /* برتقاني داكن للحواف والأزرار */
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Tahoma", Arial, sans-serif;
    background:#f5f5f5;
    color:var(--dark);
  }

  /* Top bar */
  .topbar{
    background:var(--orange);
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 18px;
    box-shadow:0 2px 6px rgba(0,0,0,0.08);
  }
  .brand {
    display:flex;
    align-items:center;
    gap:12px;
  }
  .brand img{
    height:44px;
    width:44px;
    border-radius:8px;
    object-fit:cover;
    box-shadow:0 2px 6px rgba(0,0,0,0.12);
  }
  .brand h1{ margin:0; font-size:20px; color:var(--dark); }

  .top-actions{
    display:flex;
    gap:10px;
    align-items:center;
  }
  button.top-btn{
    background:var(--dark);
    color:#fff;
    border:none;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-size:14px;
  }
  button.top-btn.secondary{
    background:rgba(0,0,0,0.08);
    color:var(--dark);
  }
  /* layout */
  .container{
    max-width:1100px;
    margin:18px auto;
    padding:0 14px;
    display:grid;
    grid-template-columns: 68% 32%;
    gap:18px;
  }
  .box{
    background:var(--card);
    border-radius:12px;
    padding:18px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
  }

  /* orders list */
  .orders-grid{
    display:flex;
    flex-direction:column;
    gap:22px;
  }
  .order-card{
    border-radius:12px;
    overflow:hidden;
    background:#fff;
    box-shadow:0 6px 12px rgba(0,0,0,0.05);
  }
  .order-media{
    width:100%;
    height:260px;
    object-fit:cover;
    display:block;
  }
  .order-info{
    padding:14px 16px;
  }
  .order-info h3{ margin:0 0 8px 0; font-size:20px; }
  .order-info p{ margin:6px 0; color:var(--muted); }

  .order-actions{
    display:flex;
    gap:10px;
    margin-top:10px;
  }
  .btn{
    border:none;
    border-radius:8px;
    padding:8px 12px;
    cursor:pointer;
    font-size:14px;
  }
  .btn.primary{ background:var(--accent); color:#fff; }
  .btn.danger{ background:#c62828; color:#fff; }

  /* admin panel */
  #adminPanel .panel-actions{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:12px;
  }
  #adminPanel .panel-actions .btn{ width:100%; }

  /* modal */
  .modal{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.45);
    z-index:999;
    padding:20px;
  }
  .modal.show{ display:flex; }
  .modal-box{
    background:#fff;
    border-radius:12px;
    width:100%;
    max-width:480px;
    padding:18px;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
  }
  .modal-box h3{ margin-top:0; }
  .modal-box input[type="text"], .modal-box input[type="file"]{
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:8px;
    border:1px solid #ddd;
  }
  .modal-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }

  /* responsive: make admin panel appear above orders on small screens */
  @media (max-width:900px){
    .container{ grid-template-columns: 1fr; }
    /* order: put admin panel first */
    #adminPanel{ order:-1; margin-bottom:10px; }
    .order-media{ height:220px; }
  }

  @media (max-width:480px){
    .order-media{ height:180px; }
    .brand h1{ font-size:18px; }
  }

  /* subtle scrollbar for content */
  ::-webkit-scrollbar { height:8px; width:8px }
  ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.12); border-radius:8px }
</style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <!-- logo embedded as data URL; if you prefer replace src with your hosted URL -->
      <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAQEBAQEBAPEA8QDw8QDw8PDw8PDw8QFRUWFhURFRUYHSggGBolGxUVITEhJSkrLi4uFx8zODMsNygtLisBCgoKDg0OGxAQGy0lICYtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAKIBNwMBIgACEQEDEQH/xAAbAAEAAgMBAQAAAAAAAAAAAAAABAUCAwYBB//EADkQAAIBAgQDBgQGAwEAAAAAAAECAwQRAAUSITFBEyJRYXEGMnGBkaGxwQcUQnKSwfAjQmKS4f/EABoBAQADAQEBAAAAAAAAAAAAAAABAgMEBQb/xAAvEQEAAgIBAgQGAwEAAAAAAAAAAQIDEQQSITEFEyJBUWEUcZGh8AUyQqGxwfH/2gAMAwEAAhEDEQA/AK6gIAgCAIAgCAIAgCAgCAgCAIAgCAgCAgCAgCAgCAgCAgCAgDg0a1p6mca5sY0kHk2s1l+3K1T1xw3YXc1Y8p8q0t7l6kqYp2Vpjb0u1hNE0lJpii1m6p4b8e8Q+u1+o5l+XJ5c6o6kyb6dZTcZEbK4x7Xx6mQb+2v1Lw8nX8p2MvrF8q6kq0rXcYQz8uR7j0H8j6+5c8/3Yl2cV3C5qV1pJrZ0qY6qaxrG8v8Aq5qkqYp2Y6rG8v8Ar5qkqYp2Y6rG8v/9k=" alt="logo">
      <h1>Uber Albalad</h1>
    </div>

    <div class="top-actions">
      <button id="adminBtn" class="top-btn">المشرفين</button>
      <button id="logoutBtn" class="top-btn" style="display:none">تسجيل خروج</button>
    </div>
  </div>

  <main class="container">
    <!-- Orders column -->
    <section class="box">
      <h2>قائمة الطلبات</h2>
      <div id="ordersList" class="orders-grid">جاري التحميل...</div>
    </section>

    <!-- Admin panel -->
    <aside id="adminPanel" class="box" style="display:none">
      <h2>لوحة المشرف</h2>
      <div class="panel-actions">
        <button class="btn primary" id="btnAdd">إضافة طلب</button>
        <button class="btn" id="btnDummy" style="display:none">زر إضافي</button>
      </div>
    </aside>
  </main>

  <!-- Add modal -->
  <div id="addModal" class="modal" aria-hidden="true">
    <div class="modal-box">
      <h3>إضافة طلب جديد</h3>
      <input id="itemName" type="text" placeholder="اسم المنتج">
      <input id="itemDelivery" type="text" placeholder="رقم الديلفري">
      <input id="itemImage" type="file" accept="image/*">
      <div class="modal-actions">
        <button class="btn" id="cancelAdd">إلغاء</button>
        <button class="btn primary" id="saveAdd">حفظ</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  // ====== إعداد Firebase ======
  const firebaseConfig = {
    apiKey: "AIzaSyAbMI7WprkW6WQeXp_XFToSELGnKu49OfQ",
    authDomain: "uber-albalad.firebaseapp.com",
    databaseURL: "https://uber-albalad-default-rtdb.firebaseio.com",
    projectId: "uber-albalad",
    storageBucket: "uber-albalad.appspot.com",
    messagingSenderId: "848401880868",
    appId: "1:848401880868:web:5801175b6991ff1ea005b1"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ====== إعدادات أخرى ======
  const IMGBB_KEY = "68c540b347198695d555d31b09a23bd1"; // مفتاح الـ IMGBB الذي أعطيتني إياه

  // عناصر DOM
  const adminBtn = document.getElementById("adminBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const adminPanel = document.getElementById("adminPanel");
  const ordersList = document.getElementById("ordersList");

  const addModal = document.getElementById("addModal");
  const btnAdd = document.getElementById("btnAdd");
  const cancelAdd = document.getElementById("cancelAdd");
  const saveAdd = document.getElementById("saveAdd");

  const itemName = document.getElementById("itemName");
  const itemDelivery = document.getElementById("itemDelivery");
  const itemImage = document.getElementById("itemImage");

  let isAdmin = false;

  // واجهة المشرف: تسجيل دخول بالمفتاح
  adminBtn.addEventListener("click", () => {
    const code = prompt("ادخل كود المشرف:");
    if (code === "010100") {
      isAdmin = true;
      adminPanel.style.display = "block";
      logoutBtn.style.display = "inline-block";
      // إعادة تحميل الطلبات لعرض أزرار الحذف
      loadOrders();
      alert("تم تسجيل دخول المشرف");
    } else {
      alert("الكود غير صحيح");
    }
  });

  logoutBtn.addEventListener("click", () => {
    isAdmin = false;
    adminPanel.style.display = "none";
    logoutBtn.style.display = "none";
    loadOrders();
    alert("تم تسجيل الخروج");
  });

  // فتح/غلق نافذة الإضافة
  btnAdd.addEventListener("click", openAddModal);
  cancelAdd.addEventListener("click", closeAddModal);
  saveAdd.addEventListener("click", saveOrder);

  // Expose functions to window so inline onclick (if any) won't error
  window.openAddModal = openAddModal;
  window.closeAddModal = closeAddModal;
  window.deleteOrder = deleteOrder;

  function openAddModal(){
    addModal.classList.add("show");
    addModal.setAttribute("aria-hidden","false");
  }
  function closeAddModal(){
    addModal.classList.remove("show");
    addModal.setAttribute("aria-hidden","true");
    // reset fields
    itemName.value = "";
    itemDelivery.value = "";
    itemImage.value = "";
  }

  // رفع الصورة إلى imgbb (تعود بعنوان الصورة)
  async function uploadImageToImgbb(file){
    try{
      const form = new FormData();
      form.append("image", file);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
        method: "POST",
        body: form
      });
      const json = await res.json();
      if(json && json.success && json.data && json.data.url){
        return json.data.url;
      } else {
        console.error("imgbb response:", json);
        throw new Error("فشل رفع الصورة إلى imgbb");
      }
    }catch(err){
      console.error(err);
      throw err;
    }
  }

  // حفظ الطلب في Firebase
  async function saveOrder(){
    const name = itemName.value && itemName.value.trim();
    const delivery = itemDelivery.value && itemDelivery.value.trim();
    const file = itemImage.files[0];

    if(!name || !delivery || !file){
      alert("املأ كل الحقول (الاسم - رقم الديلفري - صورة)");
      return;
    }

    try{
      saveAdd.disabled = true;
      saveAdd.textContent = "جاري الحفظ...";
      const imgURL = await uploadImageToImgbb(file);
      await push(ref(db, "orders"), {
        name, delivery, image: imgURL, createdAt: Date.now()
      });
      closeAddModal();
    }catch(err){
      alert("حصل خطأ أثناء الحفظ. تأكد من اتصال الإنترنت والمفتاح صالح.");
    }finally{
      saveAdd.disabled = false;
      saveAdd.textContent = "حفظ";
    }
  }

  // حذف طلب
  function deleteOrder(id){
    if(!isAdmin){ alert("لا تملك صلاحية الحذف"); return; }
    if(confirm("هل تريد حذف هذا الطلب؟")){
      remove(ref(db, "orders/" + id));
    }
  }

  // تحميل الطلبات وعرضها
  function loadOrders(){
    onValue(ref(db, "orders"), snapshot => {
      const data = snapshot.val();
      ordersList.innerHTML = "";
      if(!data){
        ordersList.innerHTML = "<p>لا توجد طلبات حاليا</p>";
        return;
      }
      // ترتيب حسب التاريخ تنازلياً إذا وُجد createdAt
      const entries = Object.entries(data).sort((a,b)=>{
        const aa = a[1].createdAt || 0;
        const bb = b[1].createdAt || 0;
        return bb - aa;
      });
      entries.forEach(([id, item])=>{
        const div = document.createElement("div");
        div.className = "order-card";

        // create inner HTML
        div.innerHTML = `
          <img class="order-media" src="${item.image || ''}" alt="${escapeHtml(item.name||'')}" />
          <div class="order-info">
            <h3>${escapeHtml(item.name||'')}</h3>
            <p>الديلفري: ${escapeHtml(item.delivery||'')}</p>
            <div class="order-actions">
              ${isAdmin ? `<button class="btn danger" data-id="${id}">حذف</button>` : ''}
            </div>
          </div>
        `;
        // attach delete handler if admin
        if(isAdmin){
          const delBtn = div.querySelector("button.danger");
          delBtn.addEventListener("click", ()=> deleteOrder(id));
        }
        ordersList.appendChild(div);
      });
    });
  }

  // small helper to escape HTML
  function escapeHtml(s){
    if(!s) return '';
    return String(s).replace(/[&<>"']/g, function(m){
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
    });
  }

  // start
  loadOrders();

</script>
</body>
</html>
